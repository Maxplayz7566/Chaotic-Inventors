<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <script src="script.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" />
        <style>
            h1 {
                position: absolute;
                top: 5%;
                x: 50%;
            }

            .qrnip {
                position: absolute;
                bottom: 5%;
                x: 50%;
                display: flex;
                gap: 15px;
                justify-content: center;
            }
        </style>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap");
        </style>
        <script>
            function getLastSegment(ipAddress) {
                // Split the IP address by '.'
                const segments = ipAddress.split(".");
                // Get the last segment
                let lastSegment = segments[segments.length - 1];
                // Pad the segment to ensure it has 3 digits
                lastSegment = lastSegment.padStart(3, "0");
                return lastSegment;
            }

            function tryGetIp() {
                // Check if pywebview is defined
                if (
                    typeof pywebview !== "undefined" &&
                    pywebview.api &&
                    pywebview.api.getIp
                ) {
                    pywebview.api
                        .getIp()
                        .then(function (data) {
                            // If data is valid, we assume success
                            if (data) {
                                console.log(getLastSegment(data));
                                document.getElementById(
                                    "asgduijasndujwd"
                                ).innerText = "Connect via QR Code, URL or code: " + getLastSegment(data);
                                document.getElementById(
                                    "connectviaip"
                                ).innerText = "http://" + data + ":5000";
                                document.getElementById(
                                    "QRCODE"
                                ).src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://${data}:5000`;
                            } else {
                                // Retry after 1 millisecond if data is not valid
                                setTimeout(tryGetIp, 1);
                            }
                        })
                        .catch(function (error) {
                            // Retry after 1 millisecond if there is an error
                            console.error(error);
                            setTimeout(tryGetIp, 1);
                        });
                } else {
                    // Retry after 1 millisecond if pywebview is not defined
                    setTimeout(tryGetIp, 1);
                }
            }

            // Initial call to start the process
            tryGetIp();

            // Store active animations
            const animations = [];

            // Function to animate a single piece of text
            function createTextAnimation(text, duration) {
                // Set up the canvas and context
                const canvas = document.getElementById("myCanvas");
                const ctx = canvas.getContext("2d");

                // Set canvas size to fill the viewport
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const startY = canvas.height;
                const endY = -100; // Text will fly off-screen above
                const randomX = Math.random() * canvas.width;

                // Add a new animation to the list
                animations.push({
                    text,
                    duration,
                    startTime: performance.now(),
                    startY,
                    endY,
                    randomX,
                });
            }

            // Function to update and draw all animations
            function update() {
                // Set up the canvas and context
                const canvas = document.getElementById("myCanvas");
                const ctx = canvas.getContext("2d");

                // Set canvas size to fill the viewport
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const startY = canvas.height;
                const endY = -100; // Text will fly off-screen above
                const randomX = Math.random() * canvas.width;
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Iterate over the active animations
                for (const animation of animations) {
                    const { text, duration, startTime, startY, endY, randomX } =
                        animation;
                    const elapsed = performance.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1); // Clamp progress between 0 and 1

                    // Calculate the current position of the text
                    const currentY = startY - (startY - endY) * progress;

                    // Draw the text
                    ctx.font = `3em "System-ui"`;
                    ctx.fillStyle = "black";
                    ctx.textAlign = "center";
                    ctx.fillText(text, randomX, currentY);

                    // Remove the animation if it is complete
                    if (progress >= 1) {
                        // Using indexOf for removal by reference
                        const index = animations.indexOf(animation);
                        if (index > -1) {
                            animations.splice(index, 1);
                        }
                    }
                }

                // Request the next animation frame
                requestAnimationFrame(update);
            }

            function addText(text, duration) {
                update();
                createTextAnimation(text, duration);
            }
        </script>
    </head>
    <body>
        <canvas
            id="myCanvas"
            style="position: absolute; size: 100%; overflow: hidden"
        ></canvas>
        <label style="position: absolute; bottom: 5px; right: 5px" class="switch">
            <input id="enableAudio" type="checkbox" checked>
            <span class="slider-on round" id="enableAudio2"></span>
        </label>        
        <h1 id="asgduijasndujwd">Connect via QR, URL or</h1>
        <button
            style="position: absolute; top: 5px; right: 5px"
            onclick="window.pywebview.api.startGame();"
        >
            Start!
        </button>
        <div id="playerlist" style="z-index: 10000;"></div>
        <div
            class="qrnip"
            style="
                display: flex;
                justify-content: center;
                align-items: center;
                height: 128px;
            "
        >
            <h2 id="connectviaip" style="margin: 0; padding-right: 10px">
                Loading
            </h2>
            <img id="QRCODE" src="" style="width: 128px; max-width: 128px" />
        </div>

        <script>
            var audio = new Audio("/ost1.wav");
            var enableAudio = document.getElementById("enableAudio");

            enableAudio.addEventListener("click", (ev) => {
                pywebview.api.setMusic(enableAudio.checked);

                console.log(enableAudio.checked);
                const slider = document.getElementById("enableAudio2");

                if (enableAudio.checked) {
                    slider.classList.add("slider-on");
                    slider.classList.remove("slider-off");

                    audio.play();
                } else {
                    slider.classList.add("slider-off");
                    slider.classList.remove("slider-on");

                    audio.pause();
                }
            });

            setTimeout(function () {
                // Attempt to play audio on page load
                audio
                    .play()
                    .then(() => {
                        console.log("Audio is playing");
                    })
                    .catch((error) => {
                        window.location.reload();
                    });
            }, 150);
        </script>
    </body>
</html>
